(function(){"use strict";var r=(l=>(l.SOROBAN="SOROBAN",l.SUANPAN="SUANPAN",l.SCHOOL="SCHOOL",l))(r||{});const H=.25,R=.9;class O{constructor(t,e,s,i,a){this.isActive=!1,this.isHovered=!1,this.pos=0,this.targetPos=0,this.x=0,this.y=0,this.w=0,this.h=0,this.inactiveX=0,this.inactiveY=0,this.activeX=0,this.activeY=0,this.rodIndex=t,this.groupIndex=e,this.index=s,this.value=i,this.color=a}update(){const t=this.targetPos-this.pos;Math.abs(t)<.001?this.pos=this.targetPos:this.pos+=t*H}updateRenderCoords(){this.x=this.inactiveX+(this.activeX-this.inactiveX)*this.pos,this.y=this.inactiveY+(this.activeY-this.inactiveY)*this.pos}}class I{constructor(t){this.groups=[],this.index=t}}class M{constructor(t,e){this.rods=[],this.requestRef=null,this.decimalPlaces=0,this.cursor={active:!1,x:0,y:0,targetBead:null},this.width=0,this.height=0,this.framePadding=20,this.rodSpacing=0,this.beamY=0,this.canvas=t,this.ctx=t.getContext("2d",{alpha:!1}),this.onTotalChange=e,this.handleStart=this.handleStart.bind(this),this.handleMove=this.handleMove.bind(this),this.handleEnd=this.handleEnd.bind(this),t.addEventListener("mousedown",s=>this.handleStart(s.offsetX,s.offsetY)),window.addEventListener("mousemove",s=>{if(this.cursor.active){const i=t.getBoundingClientRect();this.handleMove(s.clientX-i.left,s.clientY-i.top)}}),window.addEventListener("mouseup",this.handleEnd),t.addEventListener("touchstart",s=>{s.preventDefault();const i=t.getBoundingClientRect(),a=s.touches[0];this.handleStart(a.clientX-i.left,a.clientY-i.top)},{passive:!1}),t.addEventListener("touchmove",s=>{if(s.preventDefault(),this.cursor.active){const i=t.getBoundingClientRect(),a=s.touches[0];this.handleMove(a.clientX-i.left,a.clientY-i.top)}},{passive:!1}),t.addEventListener("touchend",this.handleEnd)}init(t){this.scheme=t,this.createBeads(),this.resize(this.canvas.clientWidth,this.canvas.clientHeight),this.startLoop()}setScheme(t){this.scheme=t,this.createBeads(),this.resize(this.width,this.height),this.notifyTotal()}setDecimalPlaces(t){this.decimalPlaces=t,this.notifyTotal()}reset(){this.rods.forEach(t=>{t.groups.forEach(e=>{e.forEach(s=>{s.isActive=!1,s.targetPos=0})})}),this.notifyTotal()}destroy(){this.requestRef&&cancelAnimationFrame(this.requestRef),window.removeEventListener("mouseup",this.handleEnd)}createBeads(){this.rods=[];for(let t=0;t<this.scheme.rods;t++){const e=new I(t);this.scheme.groups.forEach((s,i)=>{const a=[];for(let o=0;o<s.count;o++){let n=s.color||this.scheme.beadColor;s.colors&&s.colors.length>0&&(s.colors.length===s.count?n=s.colors[o]:o<5?n=s.colors[0]:n=s.colors[1]||s.colors[0]);const d=new O(t,i,o,s.value,n);a.push(d)}e.groups.push(a)}),this.rods.push(e)}}resize(t,e){this.width=t,this.height=e;const s=window.devicePixelRatio||1;this.canvas.width=t*s,this.canvas.height=e*s,this.ctx.scale(s,s),t<400?this.framePadding=10:this.framePadding=20,this.calculateLayout()}calculateLayout(){const{orientation:t,groups:e}=this.scheme,s=t==="vertical",i=this.width-this.framePadding*2,a=this.height-this.framePadding*2;if(s){this.rodSpacing=i/this.scheme.rods;const o=this.rodSpacing*R,n=e.some(h=>h.position==="top"),d=e.some(h=>h.position==="bottom");let m=0,v=0,p=0;if(n&&d){p=10;const h=this.scheme.id===r.SUANPAN?.35:.3,b=a-p;m=b*h,v=b*(1-h),this.beamY=this.framePadding+m+p/2}else v=a,this.beamY=this.framePadding;this.rods.forEach((h,b)=>{const S=this.framePadding+b*this.rodSpacing+this.rodSpacing/2;h.groups.forEach((c,y)=>{const E=e[y].position==="top",A=c.length,C=E?m:v,w=E?this.framePadding:this.framePadding+m+p,f=Math.min(o*.7,C/(A+1.2));c.forEach((u,P)=>{if(u.w=o,u.h=f,E){u.inactiveY=w+P*f;const T=(A-1-P)*f;u.activeY=w+C-f-T}else{u.activeY=w+P*f;const T=(A-1-P)*f;u.inactiveY=w+C-f-T}u.inactiveX=S-o/2,u.activeX=S-o/2})})})}else{const o=a/this.scheme.rods,n=o*.8,d=Math.min(n,i/15);this.rods.forEach((m,v)=>{const p=this.framePadding+v*o+o/2;m.groups.forEach((h,b)=>{const S=h.length;h.forEach((c,y)=>{c.h=n,c.w=d,c.y=p-n/2,c.activeY=c.y,c.inactiveY=c.y,c.activeX=this.framePadding+y*d;const L=(S-1-y)*d;c.inactiveX=this.width-this.framePadding-d-L})})})}this.rods.forEach(o=>o.groups.forEach(n=>n.forEach(d=>d.updateRenderCoords())))}startLoop(){const t=()=>{this.update(),this.draw(),this.requestRef=requestAnimationFrame(t)};this.requestRef=requestAnimationFrame(t)}update(){this.rods.forEach(t=>t.groups.forEach(e=>e.forEach(s=>{s.update(),s.updateRenderCoords()})))}draw(){const{ctx:t,width:e,height:s}=this;if(t.fillStyle=this.scheme.frameColor,t.fillRect(0,0,e,s),t.fillStyle="#ffffff",t.fillRect(this.framePadding,this.framePadding,e-this.framePadding*2,s-this.framePadding*2),t.lineWidth=4,t.strokeStyle=this.scheme.rodColor,t.beginPath(),this.rods.forEach(i=>{if(this.scheme.orientation==="vertical"){const a=i.groups[0][0].inactiveX+i.groups[0][0].w/2;t.moveTo(a,this.framePadding),t.lineTo(a,s-this.framePadding)}else{const a=i.groups[0][0].y+i.groups[0][0].h/2;t.moveTo(this.framePadding,a),t.lineTo(e-this.framePadding,a)}}),t.stroke(),this.scheme.orientation==="vertical"&&this.beamY>0){t.fillStyle=this.scheme.beamColor||"#333",t.fillRect(this.framePadding,this.beamY-5,e-this.framePadding*2,10);const i=this.scheme.rods-1-this.decimalPlaces;if(i>=0&&i<this.rods.length){const o=this.rods[i].groups[0][0],n=o.inactiveX+o.w/2;t.fillStyle="#ffffff",t.beginPath(),t.arc(n,this.beamY,4,0,Math.PI*2),t.fill(),t.strokeStyle="#000000",t.lineWidth=1,t.stroke()}}this.rods.forEach(i=>{i.groups.forEach(a=>{a.forEach(o=>{this.drawBead(o)})})}),this.cursor.active&&this.drawCursor()}drawBead(t){const e=this.ctx,{x:s,y:i,w:a,h:o}=t;if(e.fillStyle=t.color,t.isHovered&&(e.fillStyle=Y(t.color,40)),this.scheme.beadShape==="round"){e.beginPath();const n=Math.min(a,o)/2;e.roundRect(s,i,a,o,n),e.fill(),e.fillStyle="rgba(255,255,255,0.3)",e.beginPath(),e.ellipse(s+a*.3,i+o*.3,a*.1,o*.1,0,0,Math.PI*2),e.fill()}else this.scheme.beadShape==="bicone"?(e.beginPath(),e.moveTo(s,i+o*.1),e.lineTo(s+a/2,i-o*.1),e.lineTo(s+a,i+o*.1),e.lineTo(s+a,i+o*.9),e.lineTo(s+a/2,i+o*1.1),e.lineTo(s,i+o*.9),e.closePath(),e.beginPath(),e.moveTo(s+a/2,i),e.lineTo(s+a,i+o/2),e.lineTo(s+a/2,i+o),e.lineTo(s,i+o/2),e.closePath(),e.fill(),e.strokeStyle="rgba(0,0,0,0.1)",e.lineWidth=1,e.stroke()):(e.beginPath(),e.ellipse(s+a/2,i+o/2,a/2,o/2,0,0,Math.PI*2),e.fill())}drawCursor(){const{x:t,y:e}=this.cursor;this.ctx.beginPath(),this.ctx.strokeStyle="rgba(0, 0, 0, 0.2)",this.ctx.lineWidth=2,this.ctx.arc(t,e,25,0,Math.PI*2),this.ctx.stroke(),this.ctx.fillStyle="rgba(0, 150, 255, 0.2)",this.ctx.beginPath(),this.ctx.arc(t,e,20,0,Math.PI*2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.fillStyle="rgba(0,0,0,0.5)",this.ctx.arc(t,e,2,0,Math.PI*2),this.ctx.fill()}hitTest(t,e){for(const s of this.rods){if(s.groups.length>0&&s.groups[0].length>0){const i=s.groups[0][0];if(t<i.x-10||t>i.x+i.w+10)continue}for(const i of s.groups)for(const a of i)if(t>=a.x-5&&t<=a.x+a.w+5&&e>=a.y-5&&e<=a.y+a.h+5)return a}return null}handleStart(t,e){this.cursor.active=!0,this.cursor.x=t,this.cursor.y=e,this.checkBeamClear(t,e),this.updateCursorTarget()}handleMove(t,e){if(!this.cursor.active)return;this.cursor.x=t,this.cursor.y=e,this.checkBeamClear(t,e)?(this.cursor.targetBead=null,this.clearHovers()):this.updateCursorTarget()}checkBeamClear(t,e){if(this.scheme.orientation==="vertical"&&this.beamY>0&&Math.abs(e-this.beamY)<25){const s=Math.floor((t-this.framePadding)/this.rodSpacing);if(s>=0&&s<this.rods.length)return this.clearRod(s),!0}return!1}clearRod(t){const e=this.rods[t];let s=!1;e.groups.forEach(i=>i.forEach(a=>{a.isActive&&(a.isActive=!1,a.targetPos=0,s=!0)})),s&&this.notifyTotal()}handleEnd(){if(this.cursor.active){if(this.cursor.targetBead){const t=this.cursor.targetBead,e=this.rods[t.rodIndex],s=e.groups[t.groupIndex];this.interactBead(t,e,s)}this.cursor.active=!1,this.clearHovers(),this.cursor.targetBead=null}}updateCursorTarget(){const t=this.hitTest(this.cursor.x,this.cursor.y);t!==this.cursor.targetBead&&(this.clearHovers(),this.cursor.targetBead=t,t&&(t.isHovered=!0))}clearHovers(){this.rods.forEach(t=>t.groups.forEach(e=>e.forEach(s=>s.isHovered=!1)))}interactBead(t,e,s){const i=this.scheme.orientation==="vertical",a=t.groupIndex===0&&i&&this.scheme.groups.length>1,o=!t.isActive;if(this.scheme.id===r.SCHOOL)if(o)for(let n=0;n<=t.index;n++)this.setBeadState(s[n],!0);else for(let n=t.index;n<s.length;n++)this.setBeadState(s[n],!1);else if(a)if(o)for(let n=t.index;n<s.length;n++)this.setBeadState(s[n],!0);else for(let n=0;n<=t.index;n++)this.setBeadState(s[n],!1);else if(o)for(let n=0;n<=t.index;n++)this.setBeadState(s[n],!0);else for(let n=t.index;n<s.length;n++)this.setBeadState(s[n],!1);this.notifyTotal()}setBeadState(t,e){t.isActive=e,t.targetPos=e?1:0}notifyTotal(){let t=0;if(this.rods.forEach((e,s)=>{let i=0;if(e.groups.forEach(a=>{a.forEach(o=>{o.isActive&&(i+=o.value)})}),this.scheme.placeValue){const a=this.scheme.rods-1-this.decimalPlaces-s;t+=i*Math.pow(10,a)}else t+=i}),this.decimalPlaces>0){const e=Math.pow(10,this.decimalPlaces);t=Math.round(t*e)/e}this.onTotalChange(t)}}function Y(l,t){const e=parseInt(l.replace("#",""),16),s=Math.round(2.55*t),i=(e>>16)+s,a=(e>>8&255)+s,o=(e&255)+s;return"#"+(16777216+(i<255?i<1?0:i:255)*65536+(a<255?a<1?0:a:255)*256+(o<255?o<1?0:o:255)).toString(16).slice(1)}const x={[r.SOROBAN]:{id:r.SOROBAN,name:"Soroban",rods:13,orientation:"vertical",placeValue:!0,beadShape:"bicone",beadColor:"#8B4513",frameColor:"#1a1a1a",rodColor:"#e5e7eb",beamColor:"#e5e7eb",groups:[{count:1,value:5,position:"top",color:"#3b82f6"},{count:4,value:1,position:"bottom",colors:["#22c55e","#eab308","#f97316","#ef4444"]}]},[r.SUANPAN]:{id:r.SUANPAN,name:"Suanpan",rods:13,orientation:"vertical",placeValue:!0,beadShape:"oval",beadColor:"#4b5563",frameColor:"#78350f",rodColor:"#fde68a",beamColor:"#fde68a",groups:[{count:2,value:5,position:"top"},{count:5,value:1,position:"bottom"}]},[r.SCHOOL]:{id:r.SCHOOL,name:"School",rods:10,orientation:"horizontal",placeValue:!1,beadShape:"round",beadColor:"#dc2626",frameColor:"#f3f4f6",rodColor:"#9ca3af",groups:[{count:10,value:1,position:"row",colors:["#dc2626","#ffffff"]}]}};class B{constructor(t,e={}){var n;this.total=0,this.totalDisplay=null,this.styleSelect=null,this.decimalSelect=null,this.decimalContainer=null,this.container=t;const s=(n=t.getAttribute("data-style"))==null?void 0:n.toUpperCase();this.currentStyle=e.style||s||r.SOROBAN;const i=t.getAttribute("data-decimals");this.decimalPlaces=i?parseInt(i):e.decimals??0;const a=t.tagName.toLowerCase()==="canvas",o=t.getAttribute("data-ui");this.showUI=o!==null?o==="true":e.showUI??!a,this.initUI(),this.initEngine(),this.attachEvents()}initUI(){this.showUI?(this.container.innerHTML=`
        <div class="abacus-instance flex flex-col h-full w-full bg-slate-50 text-slate-900 overflow-hidden no-select border border-slate-200 rounded-lg shadow-sm">
          <header class="flex-none p-3 sm:p-4 bg-white shadow-sm border-b border-slate-200 z-10 flex flex-wrap items-center justify-between gap-y-3 gap-x-4">
            <div class="flex flex-wrap items-center gap-3 sm:gap-4">
              <h1 class="text-lg sm:text-xl font-bold tracking-tight text-slate-800 hidden xs:block">
                Abacus<span class="text-blue-600">.js</span>
              </h1>
              
              <div class="flex items-center gap-2">
                <select class="style-select bg-slate-100 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 outline-none">
                  ${Object.values(x).map(t=>`<option value="${t.id}" ${t.id===this.currentStyle?"selected":""}>${t.name}</option>`).join("")}
                </select>
                
                <div class="decimal-container flex items-center gap-1 sm:gap-2 px-1 sm:px-2 border-l border-slate-200 ml-1 sm:ml-2">
                    <label class="text-[10px] sm:text-xs text-slate-500 font-semibold uppercase hidden sm:inline-block">Decimals</label>
                    <select class="decimal-select bg-slate-100 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 outline-none w-14 sm:w-16">
                        ${[0,1,2,3,4].map(t=>`<option value="${t}" ${t===this.decimalPlaces?"selected":""}>${t}</option>`).join("")}
                    </select>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-3 sm:gap-6 ml-auto sm:ml-0">
               <div class="flex flex-col items-end">
                 <span class="text-[10px] sm:text-xs uppercase font-semibold text-slate-400">Total</span>
                 <span class="total-display text-2xl sm:text-3xl font-mono font-bold text-slate-900 leading-none">0</span>
               </div>
               <button class="reset-btn px-3 py-1.5 sm:px-4 sm:py-2 bg-slate-800 hover:bg-slate-700 text-white text-sm sm:text-base rounded-md font-medium transition-colors shadow-sm active:translate-y-0.5">
                 Reset
               </button>
            </div>
          </header>

          <main class="flex-1 w-full relative overflow-hidden bg-slate-200 p-2 sm:p-4 md:p-8">
            <div class="w-full h-full relative bg-white rounded-lg sm:rounded-xl shadow-xl overflow-hidden border border-slate-300">
                <canvas class="abacus-canvas w-full h-full block cursor-pointer touch-none"></canvas>
            </div>
          </main>
          
          <footer class="flex-none p-2 text-center text-[10px] sm:text-xs text-slate-400 bg-slate-50 border-t border-slate-200">
            Touch and drag beads to move.
          </footer>
        </div>
      `,this.totalDisplay=this.container.querySelector(".total-display"),this.styleSelect=this.container.querySelector(".style-select"),this.decimalSelect=this.container.querySelector(".decimal-select"),this.decimalContainer=this.container.querySelector(".decimal-container"),this.canvas=this.container.querySelector(".abacus-canvas")):this.container instanceof HTMLCanvasElement?(this.canvas=this.container,this.canvas.classList.add("cursor-pointer","touch-none")):(this.container.style.position="relative",this.container.innerHTML='<canvas class="abacus-canvas w-full h-full block cursor-pointer touch-none"></canvas>',this.canvas=this.container.querySelector(".abacus-canvas"))}initEngine(){this.engine=new M(this.canvas,t=>{this.total=t,this.updateTotalDisplay(),this.container.dispatchEvent(new CustomEvent("abacus:change",{detail:{total:t}}))}),this.engine.init(x[this.currentStyle]),this.engine.setDecimalPlaces(this.decimalPlaces),this.updateControlsVisibility(),this.updateTotalDisplay()}attachEvents(){var t,e,s;(t=this.styleSelect)==null||t.addEventListener("change",i=>{this.currentStyle=i.target.value,this.engine.setScheme(x[this.currentStyle]),this.updateControlsVisibility()}),(e=this.decimalSelect)==null||e.addEventListener("change",i=>{this.decimalPlaces=Number(i.target.value),this.engine.setDecimalPlaces(this.decimalPlaces),this.updateTotalDisplay()}),(s=this.container.querySelector(".reset-btn"))==null||s.addEventListener("click",()=>{this.engine.reset()}),window.addEventListener("resize",()=>{this.engine.resize(this.canvas.clientWidth,this.canvas.clientHeight)}),setTimeout(()=>this.engine.resize(this.canvas.clientWidth,this.canvas.clientHeight),50)}updateControlsVisibility(){if(!this.decimalContainer)return;x[this.currentStyle].placeValue?this.decimalContainer.classList.remove("hidden"):this.decimalContainer.classList.add("hidden")}updateTotalDisplay(){this.totalDisplay&&(this.totalDisplay.textContent=this.total.toLocaleString(void 0,{minimumFractionDigits:this.decimalPlaces,maximumFractionDigits:this.decimalPlaces}))}}const g={create:(l,t={})=>{const e=document.querySelector(l);if(e)return new B(e,t);console.warn("[Abacus.js] Target not found:",l)},initAll:()=>{const l={".abacus-js":void 0,".abacus-soroban":r.SOROBAN,".abacus-suanpan":r.SUANPAN,".abacus-school":r.SCHOOL};Object.entries(l).forEach(([t,e])=>{document.querySelectorAll(t).forEach(s=>{s._abacusInitialized||(new B(s,{style:e}),s._abacusInitialized=!0)})})}};window.InteractiveAbacus=g,window.createAbacus=g.create,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g.initAll):g.initAll(),document.getElementById("root")&&g.create("#root")})();
