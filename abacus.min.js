(function(){"use strict";var d=(l=>(l.SOROBAN="SOROBAN",l.SUANPAN="SUANPAN",l.SCHOOL="SCHOOL",l))(d||{});const H=.25,I=.9;class R{constructor(t,e,s,n,a){this.isActive=!1,this.isHovered=!1,this.pos=0,this.targetPos=0,this.x=0,this.y=0,this.w=0,this.h=0,this.inactiveX=0,this.inactiveY=0,this.activeX=0,this.activeY=0,this.rodIndex=t,this.groupIndex=e,this.index=s,this.value=n,this.color=a}update(){const t=this.targetPos-this.pos;Math.abs(t)<.001?this.pos=this.targetPos:this.pos+=t*H}updateRenderCoords(){this.x=this.inactiveX+(this.activeX-this.inactiveX)*this.pos,this.y=this.inactiveY+(this.activeY-this.inactiveY)*this.pos}}class M{constructor(t){this.groups=[],this.index=t}}class O{constructor(t,e){this.rods=[],this.requestRef=null,this.decimalPlaces=0,this.cursor={active:!1,x:0,y:0,targetBead:null},this.width=0,this.height=0,this.framePadding=20,this.rodSpacingSize=0,this.beamY=0,this.canvas=t,this.ctx=t.getContext("2d",{alpha:!1}),this.onTotalChange=e,this.handleStart=this.handleStart.bind(this),this.handleMove=this.handleMove.bind(this),this.handleEnd=this.handleEnd.bind(this),t.addEventListener("mousedown",s=>this.handleStart(s.offsetX,s.offsetY)),window.addEventListener("mousemove",s=>{if(this.cursor.active){const n=t.getBoundingClientRect();this.handleMove(s.clientX-n.left,s.clientY-n.top)}}),window.addEventListener("mouseup",this.handleEnd),t.addEventListener("touchstart",s=>{s.preventDefault();const n=t.getBoundingClientRect(),a=s.touches[0];this.handleStart(a.clientX-n.left,a.clientY-n.top)},{passive:!1}),t.addEventListener("touchmove",s=>{if(s.preventDefault(),this.cursor.active){const n=t.getBoundingClientRect(),a=s.touches[0];this.handleMove(a.clientX-n.left,a.clientY-n.top)}},{passive:!1}),t.addEventListener("touchend",this.handleEnd)}init(t){this.scheme=t,this.createBeads(),this.resize(this.canvas.clientWidth,this.canvas.clientHeight),this.startLoop()}setScheme(t){this.scheme=t,this.createBeads(),this.resize(this.width,this.height),this.notifyTotal()}setDecimalPlaces(t){this.decimalPlaces=t,this.notifyTotal()}reset(){this.rods.forEach(t=>{t.groups.forEach(e=>{e.forEach(s=>{s.isActive=!1,s.targetPos=0})})}),this.notifyTotal()}destroy(){this.requestRef&&cancelAnimationFrame(this.requestRef),window.removeEventListener("mouseup",this.handleEnd)}createBeads(){this.rods=[];for(let t=0;t<this.scheme.rods;t++){const e=new M(t);this.scheme.groups.forEach((s,n)=>{const a=[];for(let i=0;i<s.count;i++){let o=s.color||this.scheme.beadColor;s.colors&&s.colors.length>0&&(s.colors.length===s.count?o=s.colors[i]:i<5?o=s.colors[0]:o=s.colors[1]||s.colors[0]);const r=new R(t,n,i,s.value,o);a.push(r)}e.groups.push(a)}),this.rods.push(e)}}resize(t,e){this.width=t,this.height=e;const s=window.devicePixelRatio||1;this.canvas.width=t*s,this.canvas.height=e*s,this.ctx.scale(s,s),this.framePadding=t<400?10:20,this.calculateLayout()}calculateLayout(){const{orientation:t,groups:e}=this.scheme,s=t==="vertical",n=this.width-this.framePadding*2,a=this.height-this.framePadding*2;if(s){this.rodSpacingSize=n/this.scheme.rods;const i=this.rodSpacingSize*I,o=e.some(u=>u.position==="top"),r=e.some(u=>u.position==="bottom");let h=0,c=0,p=0;if(o&&r){p=10;const u=this.scheme.id===d.SUANPAN?.35:.3,v=a-p;h=v*u,c=v*(1-u),this.beamY=this.framePadding+h+p/2}else c=a,this.beamY=this.framePadding;this.rods.forEach((u,v)=>{const f=this.framePadding+v*this.rodSpacingSize+this.rodSpacingSize/2;u.groups.forEach((S,P)=>{const E=e[P].position==="top",A=S.length,C=E?h:c,y=E?this.framePadding:this.framePadding+h+p,g=Math.min(i*.7,C/(A+1.2));S.forEach((m,w)=>{if(m.w=i,m.h=g,E){m.inactiveY=y+w*g;const B=(A-1-w)*g;m.activeY=y+C-g-B}else{m.activeY=y+w*g;const B=(A-1-w)*g;m.inactiveY=y+C-g-B}m.inactiveX=f-i/2,m.activeX=f-i/2})})})}else{this.rodSpacingSize=a/this.scheme.rods;const i=this.rodSpacingSize*.8,o=Math.min(i,n/15);this.rods.forEach((r,h)=>{const c=this.framePadding+h*this.rodSpacingSize+this.rodSpacingSize/2;r.groups.forEach((p,u)=>{const v=p.length;p.forEach((f,S)=>{f.h=i,f.w=o;const P=c-i/2;f.activeY=P,f.inactiveY=P,f.activeX=this.framePadding+S*o;const L=(v-1-S)*o;f.inactiveX=this.width-this.framePadding-o-L})})})}this.rods.forEach(i=>i.groups.forEach(o=>o.forEach(r=>r.updateRenderCoords())))}startLoop(){const t=()=>{this.update(),this.draw(),this.requestRef=requestAnimationFrame(t)};this.requestRef=requestAnimationFrame(t)}update(){this.rods.forEach(t=>t.groups.forEach(e=>e.forEach(s=>{s.update(),s.updateRenderCoords()})))}draw(){const{ctx:t,width:e,height:s}=this;t.fillStyle=this.scheme.frameColor,t.fillRect(0,0,e,s),t.fillStyle="#f1f5f9",t.fillRect(this.framePadding,this.framePadding,e-this.framePadding*2,s-this.framePadding*2),t.lineWidth=4,t.strokeStyle=this.scheme.rodColor,t.beginPath(),this.rods.forEach(a=>{if(this.scheme.orientation==="vertical"){const i=a.groups[0][0].inactiveX+a.groups[0][0].w/2;t.moveTo(i,this.framePadding),t.lineTo(i,s-this.framePadding)}else{const i=a.groups[0][0].inactiveY+a.groups[0][0].h/2;t.moveTo(this.framePadding,i),t.lineTo(e-this.framePadding,i)}}),t.stroke();const n=this.scheme.rods-1-this.decimalPlaces;if(n>=0&&n<this.rods.length){const a=[];for(let i=n;i>=0;i-=4)a.push(i);this.scheme.orientation==="vertical"&&this.beamY>0?(t.fillStyle=this.scheme.beamColor||"#333",t.fillRect(this.framePadding,this.beamY-5,e-this.framePadding*2,10),a.forEach(i=>{const o=i===n,r=this.rods[i],h=r.groups[0][0].inactiveX+r.groups[0][0].w/2;t.strokeStyle=o?"rgba(0,0,0,0.5)":"rgba(0,0,0,0.3)",t.lineWidth=o?1.5:1,t.beginPath(),t.arc(h,this.beamY,o?4.5:3.5,0,Math.PI*2),t.stroke(),t.fillStyle=o?"#ffffff":"#cbd5e1",t.beginPath(),t.arc(h,this.beamY,o?3.5:2.5,0,Math.PI*2),t.fill()})):this.scheme.orientation==="horizontal"&&a.forEach(i=>{const o=i===n,r=this.rods[i],h=r.groups[0][0].inactiveY+r.groups[0][0].h/2,c=o?5:3.5;t.fillStyle=o?"#475569":"#94a3b8",t.beginPath(),t.arc(this.framePadding/2,h,c,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(this.width-this.framePadding/2,h,c,0,Math.PI*2),t.fill(),o&&(t.strokeStyle="#1e293b",t.lineWidth=1,t.stroke())})}this.rods.forEach(a=>a.groups.forEach(i=>i.forEach(o=>this.drawBead(o)))),this.cursor.active&&this.drawCursor()}drawBead(t){const e=this.ctx,{x:s,y:n,w:a,h:i}=t;e.fillStyle=t.color,t.isHovered&&(e.fillStyle=Y(t.color,40)),this.scheme.beadShape==="round"?(e.beginPath(),e.roundRect(s,n,a,i,Math.min(a,i)/2),e.fill()):this.scheme.beadShape==="bicone"?(e.beginPath(),e.moveTo(s,n+i*.1),e.lineTo(s+a/2,n-i*.1),e.lineTo(s+a,n+i*.1),e.lineTo(s+a,n+i*.9),e.lineTo(s+a/2,n+i*1.1),e.lineTo(s,n+i*.9),e.closePath(),e.fill()):(e.beginPath(),e.ellipse(s+a/2,n+i/2,a/2,i/2,0,0,Math.PI*2),e.fill()),e.strokeStyle="rgba(0,0,0,0.15)",e.lineWidth=1.5,e.stroke(),e.fillStyle="rgba(255,255,255,0.2)",e.beginPath(),e.ellipse(s+a*.3,n+i*.3,a*.1,i*.1,0,0,Math.PI*2),e.fill()}drawCursor(){const{x:t,y:e}=this.cursor;this.ctx.beginPath(),this.ctx.strokeStyle="rgba(0, 0, 0, 0.2)",this.ctx.lineWidth=2,this.ctx.arc(t,e,25,0,Math.PI*2),this.ctx.stroke(),this.ctx.fillStyle="rgba(0, 150, 255, 0.2)",this.ctx.beginPath(),this.ctx.arc(t,e,20,0,Math.PI*2),this.ctx.fill()}hitTest(t,e){var n;const s=this.scheme.orientation==="vertical";for(const a of this.rods){if(!((n=a.groups[0])==null?void 0:n[0]))continue;const o=this.framePadding+a.index*this.rodSpacingSize,r=o+this.rodSpacingSize;if(s){if(t<o||t>r)continue}else if(e<o||e>r)continue;for(const h of a.groups)for(const c of h)if(t>=c.x-12&&t<=c.x+c.w+12&&e>=c.y-12&&e<=c.y+c.h+12)return c}return null}handleStart(t,e){this.cursor.active=!0,this.cursor.x=t,this.cursor.y=e,this.checkBeamClear(t,e),this.updateCursorTarget()}handleMove(t,e){this.cursor.active&&(this.cursor.x=t,this.cursor.y=e,this.checkBeamClear(t,e)?(this.cursor.targetBead=null,this.clearHovers()):this.updateCursorTarget())}checkBeamClear(t,e){if(this.scheme.orientation==="vertical"&&this.beamY>0&&Math.abs(e-this.beamY)<25){const s=Math.floor((t-this.framePadding)/this.rodSpacingSize);if(s>=0&&s<this.rods.length)return this.clearRod(s),!0}return!1}clearRod(t){const e=this.rods[t];let s=!1;e.groups.forEach(n=>n.forEach(a=>{a.isActive&&(a.isActive=!1,a.targetPos=0,s=!0)})),s&&this.notifyTotal()}handleEnd(){if(this.cursor.active){if(this.cursor.targetBead){const t=this.cursor.targetBead;this.interactBead(t,this.rods[t.rodIndex],this.rods[t.rodIndex].groups[t.groupIndex])}this.cursor.active=!1,this.clearHovers(),this.cursor.targetBead=null}}updateCursorTarget(){const t=this.hitTest(this.cursor.x,this.cursor.y);t!==this.cursor.targetBead&&(this.clearHovers(),this.cursor.targetBead=t,t&&(t.isHovered=!0))}clearHovers(){this.rods.forEach(t=>t.groups.forEach(e=>e.forEach(s=>s.isHovered=!1)))}interactBead(t,e,s){const n=this.scheme.orientation==="vertical",a=t.groupIndex===0&&n&&this.scheme.groups.length>1,i=!t.isActive;if(this.scheme.id===d.SCHOOL)if(i)for(let o=0;o<=t.index;o++)this.setBeadState(s[o],!0);else for(let o=t.index;o<s.length;o++)this.setBeadState(s[o],!1);else if(a)if(i)for(let o=t.index;o<s.length;o++)this.setBeadState(s[o],!0);else for(let o=0;o<=t.index;o++)this.setBeadState(s[o],!1);else if(i)for(let o=0;o<=t.index;o++)this.setBeadState(s[o],!0);else for(let o=t.index;o<s.length;o++)this.setBeadState(s[o],!1);this.notifyTotal()}setBeadState(t,e){t.isActive=e,t.targetPos=e?1:0}notifyTotal(){let t=0;if(this.rods.forEach((e,s)=>{let n=0;if(e.groups.forEach(a=>a.forEach(i=>{i.isActive&&(n+=i.value)})),this.scheme.placeValue){const a=this.scheme.rods-1-this.decimalPlaces-s;t+=n*Math.pow(10,a)}else t+=n}),this.decimalPlaces>0){const e=Math.pow(10,this.decimalPlaces);t=Math.round(t*e)/e}this.onTotalChange(t)}}function Y(l,t){const e=parseInt(l.replace("#",""),16),s=Math.round(2.55*t),n=(e>>16)+s,a=(e>>8&255)+s,i=(e&255)+s;return"#"+(16777216+(n<255?n<1?0:n:255)*65536+(a<255?a<1?0:a:255)*256+(i<255?i<1?0:i:255)).toString(16).slice(1)}const x={[d.SOROBAN]:{id:d.SOROBAN,name:"Soroban",rods:13,orientation:"vertical",placeValue:!0,beadShape:"bicone",beadColor:"#8B4513",frameColor:"#1a1a1a",rodColor:"#e5e7eb",beamColor:"#e5e7eb",groups:[{count:1,value:5,position:"top",color:"#3b82f6"},{count:4,value:1,position:"bottom",colors:["#22c55e","#eab308","#f97316","#ef4444"]}]},[d.SUANPAN]:{id:d.SUANPAN,name:"Suanpan",rods:13,orientation:"vertical",placeValue:!0,beadShape:"oval",beadColor:"#4b5563",frameColor:"#78350f",rodColor:"#fde68a",beamColor:"#fde68a",groups:[{count:2,value:5,position:"top"},{count:5,value:1,position:"bottom"}]},[d.SCHOOL]:{id:d.SCHOOL,name:"School",rods:10,orientation:"horizontal",placeValue:!0,beadShape:"round",beadColor:"#dc2626",frameColor:"#f3f4f6",rodColor:"#9ca3af",groups:[{count:10,value:1,position:"row",colors:["#dc2626","#cbd5e1"]}]}};class T{constructor(t,e={}){var o;this.total=0,this.totalDisplay=null,this.styleSelect=null,this.decimalSelect=null,this.decimalContainer=null,this.container=t;const s=(o=t.getAttribute("data-style"))==null?void 0:o.toUpperCase();this.currentStyle=e.style||s||d.SOROBAN;const n=t.getAttribute("data-decimals");this.decimalPlaces=n?parseInt(n):e.decimals??0;const a=t.tagName.toLowerCase()==="canvas",i=t.getAttribute("data-ui");this.showUI=i!==null?i==="true":e.showUI??!a,this.initUI(),this.initEngine(),this.attachEvents()}initUI(){this.showUI?(this.container.innerHTML=`
        <div class="abacus-instance flex flex-col h-full w-full bg-slate-50 text-slate-900 overflow-hidden no-select border border-slate-200 rounded-lg shadow-sm">
          <header class="flex-none p-3 sm:p-4 bg-white shadow-sm border-b border-slate-200 z-10 flex flex-wrap items-center justify-between gap-y-3 gap-x-4">
            <div class="flex flex-wrap items-center gap-3 sm:gap-4">
              <h1 class="text-lg sm:text-xl font-bold tracking-tight text-slate-800 hidden xs:block">
                Abacus<span class="text-blue-600">.js</span>
              </h1>
              
              <div class="flex items-center gap-2">
                <select class="style-select bg-slate-100 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 outline-none">
                  ${Object.values(x).map(t=>`<option value="${t.id}" ${t.id===this.currentStyle?"selected":""}>${t.name}</option>`).join("")}
                </select>
                
                <div class="decimal-container flex items-center gap-1 sm:gap-2 px-1 sm:px-2 border-l border-slate-200 ml-1 sm:ml-2">
                    <label class="text-[10px] sm:text-xs text-slate-500 font-semibold uppercase hidden sm:inline-block">Decimals</label>
                    <select class="decimal-select bg-slate-100 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 outline-none w-14 sm:w-16">
                        ${[0,1,2,3,4].map(t=>`<option value="${t}" ${t===this.decimalPlaces?"selected":""}>${t}</option>`).join("")}
                    </select>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-3 sm:gap-6 ml-auto sm:ml-0">
               <div class="flex flex-col items-end">
                 <span class="text-[10px] sm:text-xs uppercase font-semibold text-slate-400">Total</span>
                 <span class="total-display text-2xl sm:text-3xl font-mono font-bold text-slate-900 leading-none">0</span>
               </div>
               <button class="reset-btn px-3 py-1.5 sm:px-4 sm:py-2 bg-slate-800 hover:bg-slate-700 text-white text-sm sm:text-base rounded-md font-medium transition-colors shadow-sm active:translate-y-0.5">
                 Reset
               </button>
            </div>
          </header>

          <main class="flex-1 w-full relative overflow-hidden bg-slate-200 p-2 sm:p-4 md:p-8">
            <div class="w-full h-full relative bg-white rounded-lg sm:rounded-xl shadow-xl overflow-hidden border border-slate-300">
                <canvas class="abacus-canvas w-full h-full block cursor-pointer touch-none"></canvas>
            </div>
          </main>
          
          <footer class="flex-none p-2 text-center text-[10px] sm:text-xs text-slate-400 bg-slate-50 border-t border-slate-200">
            Touch and drag beads to move.
          </footer>
        </div>
      `,this.totalDisplay=this.container.querySelector(".total-display"),this.styleSelect=this.container.querySelector(".style-select"),this.decimalSelect=this.container.querySelector(".decimal-select"),this.decimalContainer=this.container.querySelector(".decimal-container"),this.canvas=this.container.querySelector(".abacus-canvas")):this.container instanceof HTMLCanvasElement?(this.canvas=this.container,this.canvas.classList.add("cursor-pointer","touch-none")):(this.container.style.position="relative",this.container.innerHTML='<canvas class="abacus-canvas w-full h-full block cursor-pointer touch-none"></canvas>',this.canvas=this.container.querySelector(".abacus-canvas"))}initEngine(){this.engine=new O(this.canvas,t=>{this.total=t,this.updateTotalDisplay(),this.container.dispatchEvent(new CustomEvent("abacus:change",{detail:{total:t}}))}),this.engine.init(x[this.currentStyle]),this.engine.setDecimalPlaces(this.decimalPlaces),this.updateControlsVisibility(),this.updateTotalDisplay()}attachEvents(){var t,e,s;(t=this.styleSelect)==null||t.addEventListener("change",n=>{this.currentStyle=n.target.value,this.engine.setScheme(x[this.currentStyle]),this.updateControlsVisibility()}),(e=this.decimalSelect)==null||e.addEventListener("change",n=>{this.decimalPlaces=Number(n.target.value),this.engine.setDecimalPlaces(this.decimalPlaces),this.updateTotalDisplay()}),(s=this.container.querySelector(".reset-btn"))==null||s.addEventListener("click",()=>{this.engine.reset()}),window.addEventListener("resize",()=>{this.engine.resize(this.canvas.clientWidth,this.canvas.clientHeight)}),setTimeout(()=>this.engine.resize(this.canvas.clientWidth,this.canvas.clientHeight),50)}updateControlsVisibility(){if(!this.decimalContainer)return;x[this.currentStyle].placeValue?this.decimalContainer.classList.remove("hidden"):this.decimalContainer.classList.add("hidden")}updateTotalDisplay(){this.totalDisplay&&(this.totalDisplay.textContent=this.total.toLocaleString(void 0,{minimumFractionDigits:this.decimalPlaces,maximumFractionDigits:this.decimalPlaces}))}}const b={create:(l,t={})=>{const e=document.querySelector(l);if(e)return new T(e,t);console.warn("[Abacus.js] Target not found:",l)},initAll:()=>{const l={".abacus-js":void 0,".abacus-soroban":d.SOROBAN,".abacus-suanpan":d.SUANPAN,".abacus-school":d.SCHOOL};Object.entries(l).forEach(([t,e])=>{document.querySelectorAll(t).forEach(s=>{s._abacusInitialized||(new T(s,{style:e}),s._abacusInitialized=!0)})})}};window.InteractiveAbacus=b,window.createAbacus=b.create,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",b.initAll):b.initAll(),document.getElementById("root")&&b.create("#root")})();
